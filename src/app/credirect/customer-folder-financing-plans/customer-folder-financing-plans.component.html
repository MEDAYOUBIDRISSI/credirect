<div class="card h-100">
    <div class="row">
        <div class="col-12">
            <h3>Liste des dossiers de crédit</h3>
            <p>

            </p>
        </div>
        <div class="card">
            <div class="row grid">
                <div class="col-12" >
                    <!-- Étapes avec p-steps -->
                    <p-steps [model]="steps" [activeIndex]="activeIndex" (activeIndexChange)="onStepChange($event)"></p-steps>

                    <!-- Contenu des étapes -->
                    <div *ngIf="activeIndex === 0" class="step-content">
                        <div class="grid p-fluid mt-3">
                            <div class="field col-12 md:col-6 lg:col-4">
                                <h5 for="objetCredit">Objet du Crédit</h5>
                                <p-dropdown
                                id="objetCredit"
                                [options]="objetCreditOptions"
                                [(ngModel)]="planFinancement.objetCredit"
                                placeholder="Sélectionnez l'objet du crédit"
                                ></p-dropdown>
                            </div>
                        </div>
                        <!-- Gestion des biens -->
                        <div class="grid p-field">
                            <div class="field col-12 md:col-12 lg:col-12 mb-0 pb-0">
                                <h5>Biens Associés</h5>
                            </div>
                        </div>
                        <div class="grid p-field">
                            <div class="col-12 md:col-12 lg:col-12 mb-0 pb-0">
                                <div *ngFor="let bien of planFinancement.biens; let i = index" class="bien-item card">
                                    <div class="grid">
                                        <!-- Nature du Bien -->
                                        <div class="field col-12 md:col-4 lg:col-4 styleUnderInputs">
                                            <label for="natureBien{{i}}">Nature du Bien</label>
                                            <p-dropdown
                                                id="natureBien{{i}}"
                                                [options]="natureBienOptions"
                                                [(ngModel)]="bien.nature"
                                                placeholder="Sélectionnez la nature du bien"
                                            ></p-dropdown>
                                        </div>

                                        <!-- Affectation du Bien -->
                                        <div class="field col-12 md:col-4 lg:col-4 styleUnderInputs">
                                            <label for="affectationBien{{i}}">Affectation du Bien</label>
                                            <p-dropdown
                                                id="affectationBien{{i}}"
                                                [options]="affectationBienOptions"
                                                [(ngModel)]="bien.affectation"
                                                placeholder="Sélectionnez l'affectation"
                                            ></p-dropdown>
                                        </div>

                                        <!-- Usage du Bien -->
                                        <div class="field col-12 md:col-4 lg:col-4 styleUnderInputs">
                                            <label for="usageBien{{i}}">Usage du Bien</label>
                                            <p-dropdown
                                                id="usageBien{{i}}"
                                                [options]="usageBienOptions"
                                                [(ngModel)]="bien.usage"
                                                placeholder="Sélectionnez l'usage"
                                            ></p-dropdown>
                                        </div>

                                        <!-- État du Bien -->
                                        <div class="field col-12 md:col-4 lg:col-4 styleUnderInputs">
                                            <label for="etatBien{{i}}">État du Bien</label>
                                            <p-dropdown
                                                id="etatBien{{i}}"
                                                [options]="etatBienOptions"
                                                [(ngModel)]="bien.etat"
                                                placeholder="Sélectionnez l'état"
                                            ></p-dropdown>
                                        </div>

                                        <!-- Adresse du Bien -->
                                        <div class="field col-12 md:col-4 lg:col-4 styleUnderInputs">
                                            <label for="adresseBien{{i}}">Adresse du Bien</label>
                                            <input
                                                id="adresseBien{{i}}"
                                                type="text"
                                                [(ngModel)]="bien.adresse"
                                                pInputText
                                            />
                                        </div>

                                        <!-- Superficie du Bien -->
                                        <div class="field col-12 md:col-4 lg:col-4 styleUnderInputs">
                                            <label for="superficieBien{{i}}">Superficie (m²)</label>
                                            <input
                                                id="superficieBien{{i}}"
                                                type="number"
                                                [(ngModel)]="bien.superficie"
                                                pInputText
                                            />
                                        </div>

                                        <!-- Titre Foncier -->
                                        <div class="field col-12 md:col-4 lg:col-4 styleUnderInputs">
                                            <label for="titreFoncierBien{{i}}">Titre Foncier</label>
                                            <input
                                                id="titreFoncierBien{{i}}"
                                                type="text"
                                                [(ngModel)]="bien.titreFoncier"
                                                pInputText
                                            />
                                        </div>

                                        <!-- Prix de Vente du Bien -->
                                        <div class="field col-12 md:col-4 lg:col-4 styleUnderInputs">
                                            <label for="prixVenteBien{{i}}">Prix de Vente (MAD)</label>
                                            <input
                                                id="prixVenteBien{{i}}"
                                                type="number"
                                                [(ngModel)]="bien.prixVente"
                                                pInputText/>
                                        </div>

                                        <!-- Valeur Réelle du Bien -->
                                        <div class="field col-12 md:col-4 lg:col-4 styleUnderInputs">
                                        <label for="valeurReelleBien{{i}}">Valeur Réelle (MAD)</label>
                                        <input
                                            id="valeurReelleBien{{i}}"
                                            type="number"
                                            [(ngModel)]="bien.valeurReelle"
                                            pInputText
                                        />
                                        </div>

                                        <!-- Montant des Travaux -->
                                        <div class="field col-12 md:col-4 lg:col-4 styleUnderInputs">
                                            <label for="montantTravauxBien{{i}}">Montant des Travaux (MAD)</label>
                                            <input
                                                id="montantTravauxBien{{i}}"
                                                type="number"
                                                [(ngModel)]="bien.montantTravaux"
                                                pInputText
                                            />
                                        </div>
                                    </div>
                                    <button
                                        pButton
                                        type="button"
                                        label="Supprimer"
                                        icon="pi pi-trash"
                                        class="p-button-danger p-mt-2"
                                        (click)="removeBien(i)"
                                    ></button>
                                </div>
                            </div>
                        </div>
                        <div class="grid p-field mt-2">
                            <div class="field col-12 md:col-12 lg:col-12 mb-0 pb-0">
                                <button
                                pButton
                                type="button"
                                label="Ajouter un Bien"
                                icon="pi pi-plus"
                                class="p-button-secondary"
                                (click)="addBien()"
                                ></button>
                            </div>
                        </div>
                    </div>

                    <div *ngIf="activeIndex === 1" class="step-content">
                        <div class="grid p-fluid mt-3">
                            <!-- Montant du Crédit -->
                            <div class="field col-12 md:col-4 lg:col-4 styleUnderInputs">
                                <label for="montantCredit">Montant du Crédit (MAD)</label>
                                <input
                                    id="montantCredit"
                                    type="number"
                                    [(ngModel)]="planFinancement.montantCredit"
                                    (input)="calculateMensualiteTTC()"
                                    pInputText
                                />
                            </div>
                    
                            <!-- Durée du Crédit (mois) -->
                            <div class="field col-12 md:col-4 lg:col-4 styleUnderInputs">
                                <label for="dureeCredit">Durée du Crédit (mois)</label>
                                <input
                                    id="dureeCredit"
                                    type="number"
                                    [(ngModel)]="planFinancement.dureeCredit"
                                    (input)="calculateMensualiteTTC()"
                                    pInputText
                                />
                            </div>
                    
                            <!-- Fréquence de Remboursement -->
                            <div class="field col-12 md:col-4 lg:col-4 styleUnderInputs">
                                <label for="frequenceRemboursement">Fréquence de Remboursement</label>
                                <p-dropdown
                                    id="frequenceRemboursement"
                                    [options]="frequenceOptions"
                                    [(ngModel)]="planFinancement.frequenceRemboursement"
                                    placeholder="Sélectionner"
                                ></p-dropdown>
                            </div>
                    
                            <!-- Durée de Franchise -->
                            <div class="field col-12 md:col-4 lg:col-4 styleUnderInputs">
                                <label for="dureeFranchise">Durée de Franchise (mois)</label>
                                <input
                                    id="dureeFranchise"
                                    type="number"
                                    [(ngModel)]="planFinancement.dureeFranchise"
                                    pInputText
                                />
                            </div>
                    
                            <!-- Taux du Crédit -->
                            <div class="field col-12 md:col-4 lg:col-4 styleUnderInputs">
                                <label for="tauxCredit">Taux du Crédit (%)</label>
                                <input
                                    id="tauxCredit"
                                    type="number"
                                    [(ngModel)]="planFinancement.tauxCredit"
                                    (input)="calculateMensualiteTTC()"
                                    pInputText
                                />
                            </div>
                    
                            <!-- Dérogation souhaitée -->
                            <div class="field col-12 md:col-4 lg:col-4 styleUnderInputs">
                                <label>Dérogation souhaitée</label>
                                <p-inputSwitch [(ngModel)]="planFinancement.derogationSouhaitee" ></p-inputSwitch>
                            </div>
                    
                            <!-- Assurance Décès-Invalidité -->
                            <div class="field col-12 md:col-4 lg:col-4 styleUnderInputs">
                                <label for="assurance">Assurance Décès-Invalidité</label>
                                <p-dropdown
                                    id="assurance"
                                    [options]="assuranceOptions"
                                    [(ngModel)]="planFinancement.assurance"
                                    placeholder="Sélectionner"
                                ></p-dropdown>
                            </div>
                    
                            <!-- Taux d’Assurance (only if Mensuelle) -->
                            <div *ngIf="planFinancement.assurance === 'mensuelle'" class="field col-12 md:col-4 lg:col-4 styleUnderInputs">
                                <label for="tauxAssurance">Taux d’Assurance (%)</label>
                                <input
                                    id="tauxAssurance"
                                    type="number"
                                    [(ngModel)]="planFinancement.tauxAssurance"
                                    (input)="calculateMensualiteTTC()"
                                    pInputText
                                />
                            </div>
                    
                            <!-- Mensualité TTC (calculated) -->
                            <div class="field col-12 md:col-4 lg:col-4 styleUnderInputs">
                                <label>Mensualité TTC (MAD)</label>
                                <b>{{ mensualiteTTC }}</b>
                                <!-- <p-inputText [disabled]="true" [(ngModel)]="mensualiteTTC"></p-inputText> -->
                            </div>
                    
                            <!-- Taux d’endettement Global (calculated) -->
                            <div class="field col-12 md:col-4 lg:col-4 styleUnderInputs">
                                <label>Taux d’endettement Global (%)</label>
                                <b>{{ tauxEndettementGlobal }}</b>
                                <!-- <p-inputText [disabled]="true" [(ngModel)]="tauxEndettementGlobal"></p-inputText> -->
                            </div>
                    
                            <!-- Quotité de Financement (calculated) -->
                            <div class="field col-12 md:col-4 lg:col-4 styleUnderInputs">
                                <label>Quotité de Financement (%)</label>
                                <b>{{ quotiteFinancement }}</b>
                                <!-- <p-inputText [disabled]="true" [(ngModel)]="quotiteFinancement"></p-inputText> -->
                            </div>
                        </div>
                    </div>                    

                    <div *ngIf="activeIndex === 2" class="step-content">
                        <div class="p-fluid">
                            <div class="p-field">
                                <h5 for="garanties">Garanties</h5>
                                <p-table [value]="canauxVentes" dataKey="id" [tableStyle]="{ 'width': '60vw' }">
                                    <ng-template pTemplate="body" let-canaux let-editing="editing" let-rowIndex="rowIndex">
                                        <tr>
                                            <td [pEditableColumn]="canaux.name" pEditableColumnField="name" class="px-0 class-width-mobile-canaux">
                                                <p-cellEditor>
                                                    <ng-template pTemplate="input">
                                                        <input pInputText type="text" [(ngModel)]="canaux.name" class="offerDisplayInput" (input)="checkCanaux()"/>
                                                    </ng-template>
                                                    <ng-template pTemplate="output">
                                                        <input pInputText type="text" [(ngModel)]="canaux.name" class="offerDisplayOutput" (input)="checkCanaux()" />
                                                    </ng-template>
                                                </p-cellEditor>
                                            </td>
                                            <td class="class-width-mobile-canaux-trash">
                                                <button (click)="deleteCanaux(rowIndex)" pButton pRipple type="button" icon="pi pi-trash" class="p-button-rounded p-button-text red_color"></button>
                                            </td>
                                        </tr>
                                    </ng-template>
                                </p-table>
                                <div class="mt-3 canauxVentes">
                                    <span (click)="checkCanaux()">Ajouter un garantie :</span> 
                                    <ng-container *ngFor="let canaux of canauxVentesListAfterCheck">
                                        <p-chip class="mx-1 cursorPointer chip-add-e" (click)="AddCanauxVentes(canaux.name)"><div >{{ canaux?.name }}<i class="ph ph-plus cursorPointer"></i></div></p-chip>
                                    </ng-container>
                                    <p-chip class="mx-1 cursorPointer chip-add-e" (click)="AddEmptyCanauxVentes()"><div>Other<i class="ph ph-plus cursorPointer"></i></div></p-chip>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div *ngIf="activeIndex === 3" class="step-content">
                        <div class="p-fluid">
                            <div class="p-field mt-4">
                                <h5 for="commentaires">Commentaires</h5>
                                <angular-editor [config]="ckeConfig" [(ngModel)]="planFinancement.commentaires">
                                </angular-editor>
                                <!-- <p-editor [(ngModel)]="planFinancement.commentaires" [style]="{ height: '320px' }" /> -->
                            </div>
                        </div>
                    </div>
                    <div *ngIf="activeIndex === 4" class="step-content">
                        <h3>Facturation et Dépôt</h3>
                        <p>Complétez les informations de facturation et choisissez les banques de dépôt.</p>
                      
                        <!-- Volet 1 : Complément d’information sur la facturation et honoraires client -->
                        <div class="p-fluid">
                          <div class="p-field">
                            <label for="honorairesFactures">Honoraires Facturés (MAD)</label>
                            <input
                              id="honorairesFactures"
                              type="number"
                              [(ngModel)]="facturation.honorairesFactures"
                              pInputText
                            />
                          </div>
                        </div>
                      
                        <!-- Volet 2 : Choix de banque de dépôt et suivi -->
                        <div class="p-mt-4">
                          <h4>Choix de Banque de Dépôt</h4>
                          <p>Ajoutez une ou plusieurs banques de dépôt.</p>
                      
                          <!-- Liste des dépôts -->
                          <div *ngFor="let depot of facturation.depots; let i = index" class="p-mb-4 p-p-3 p-shadow-2">
                            <div class="p-grid">
                              <!-- Banque (Dropdown) -->
                            <div class="p-col-12 p-md-4">
                                <label for="banque{{i}}">Banque</label>
                                <p-dropdown
                                id="banque{{i}}"
                                [options]="banks"
                                [(ngModel)]="depot.banque"
                                placeholder="Sélectionnez une banque"
                                ></p-dropdown>
                            </div>
                      
                              <!-- Interlocuteur -->
                              <div class="p-col-12 p-md-4">
                                <label for="interlocuteur{{i}}">Interlocuteur</label>
                                <input
                                  id="interlocuteur{{i}}"
                                  type="text"
                                  [(ngModel)]="depot.interlocuteur"
                                  pInputText
                                />
                              </div>
                      
                              <!-- Agence -->
                              <div class="p-col-12 p-md-4">
                                <label for="agence{{i}}">Agence</label>
                                <input
                                  id="agence{{i}}"
                                  type="text"
                                  [(ngModel)]="depot.agence"
                                  pInputText
                                />
                              </div>
                      
                              <!-- Date d’envoi -->
                              <div class="p-col-12 p-md-4">
                                <label for="dateEnvoi{{i}}">Date d’envoi</label>
                                <p-calendar
                                  id="dateEnvoi{{i}}"
                                  [(ngModel)]="depot.dateEnvoi"
                                  [showIcon]="true"
                                  dateFormat="dd/mm/yy"
                                ></p-calendar>
                              </div>
                      
                              <!-- Bouton Supprimer -->
                              <div class="p-col-12 p-md-4 p-d-flex p-align-center">
                                <button
                                  pButton
                                  type="button"
                                  icon="pi pi-trash"
                                  class="p-button-danger"
                                  (click)="removeDepot(i)"
                                ></button>
                              </div>
                            </div>
                          </div>
                      
                          <!-- Bouton Ajouter un Dépôt -->
                          <button
                            pButton
                            type="button"
                            label="Ajouter un Dépôt"
                            icon="pi pi-plus"
                            class="p-button-secondary"
                            (click)="addDepot()"
                          ></button>
                        </div>
                      </div>
                    <!-- Boutons de navigation -->
                    <div class="flex space-between mt-4" style="justify-content: space-between;">
                        <button
                            pButton
                            type="button"
                            label="Précédent"
                            icon="pi pi-chevron-left"
                            (click)="previousStep()"
                            [disabled]="activeIndex === 0"
                        ></button>
                        <button
                            pButton
                            type="button"
                            label="Suivant"
                            icon="pi pi-chevron-right"
                            iconPos="right"
                            (click)="nextStep()"
                            [disabled]="activeIndex === steps.length - 1"
                        ></button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>